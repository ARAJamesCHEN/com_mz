<?php
/**
 * Created by PhpStorm.
 * User: yac0105
 * Date: 12/06/2018
 * Time: 4:18 PM
 */

namespace app\controllers;


use comphp\base\Controller;
use app\controllers\formbeans\PollRstFormBeanFactory;
use app\models\modelInterface\PollModelServiceImpl;
use app\models\modelInterface\PollAndOptionsUnionService;
use app\models\modelInterface\PollAndOptionUnionServiceImpl;

include(APP_PATH . 'app/controllers/formbeans/'.'PollRstFormBean.php');

CONST POLL_RST_INIT = "init";

class PollRstController extends Controller
{

    private $formBean;

    private $pollRstBean;

    private $pollOptionRstBeanCollection;

    public function init()
    {
        parent::init(); // TODO: Change the autogenerated stub

        $this->formBean = PollRstFormBeanFactory::create();

        if(POLL_RST_INIT == $this->_actionName){

            if(isset($_SESSION['PollId'])){
                $pollID = $_SESSION['PollId'];
            }

            $pollID = 1;

            if(!empty($pollID)){

                $this->formBean->setPollId($pollID);

                $this->displayPollDetail(new PollAndOptionUnionServiceImpl(), $pollID);


            }else{
                throw new \Exception("Cannot get PollID!");
            }
        }


        $this->assign("formBean", $this->formBean);
        $this->assign("pollRstBean", $this->pollRstBean);
        $this->assign("pollOptionRstBeanCollection", $this->pollOptionRstBeanCollection);
        $this->render();
    }

    private function displayPollDetail(PollAndOptionsUnionService $pollModelService,$pollID){


        $rslt = $pollModelService->searchPollWithOptionByID($pollID);

        if(is_null($rslt)){
            $this->formBean->setWarning('Fail to find the result');
            return;
        }

        //var_dump($rslt);

        $result = $rslt->getResult();

        $this->pollRstBean = $result[0];
        $this->pollOptionRstBeanCollection = $result[1];



    }
}

